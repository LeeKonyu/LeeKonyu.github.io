I"(à<p><img src="//blog.leeky.top/images/1-smaK057Fp29kcTJPN5DdCg%20%281%29.png" alt="" /></p>

<p>åŸæ–‡æ¥è‡ªï¼š<a href="https://medium.com/javascript-inside/generators-and-channels-in-javascript-594f2cf9c16e#.pvgt62ocb">Generators and Channels in JavaScript</a></p>

<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<p>ä»¥ä¸‹è¿™ç¯‡æ–‡ç« æ˜¯å¯¹Generatorå’ŒChannelçš„ä¸€ä¸ªä»‹ç»ï¼Œå¦‚æœä½ å¯¹Promiseï¼ŒGeneratorï¼ŒCoroutineå’ŒChannelæœ‰è¿‡äº†è§£ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°Using Generators and Channels with Reactè¿™éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥è¿™äº›ä»£ç å¯èƒ½ä¸èƒ½ç›´æ¥ç”¨äºå®é™…ç”Ÿäº§ç¯å¢ƒï¼Œä½†æ˜¯å®ƒåº”è¯¥è¢«çœ‹æˆä¸€ä¸ªèµ·ç‚¹ï¼Œå¯ä»¥å°è¯•æŠŠè¿™ç§æ–¹æ¡ˆç”¨åœ¨å¯ä»¥ç”¨åˆ°çš„åœ°æ–¹ã€‚</p>

<p>ç¨å¾®èŠ±ç‚¹æ—¶é—´çœ‹çœ‹è¿™ä¸ªlistenå‡½æ•°ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">listen</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">chan</span><span class="p">()</span>
  <span class="nx">el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">putAsync</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">e</span><span class="p">))</span>
  <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span></code></pre></figure>

<p>å®ƒä¼šå°†æ¯ä¸ªåœ¨Domå…ƒç´ ä¸Šé¢çš„äº‹ä»¶è½¬æ¢ä¸€ä¸ªChannelï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªåŸºç¡€ç‚¹å¼€å§‹ã€‚</p>

<h3 id="why-generators-and-channels">Why Generators and Channels?</h3>

<p>åœ¨æˆ‘ä»¬å­¦ä¹ Generatorï¼ŒCoroutineå’ŒChannelä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹å¸¸è§„çš„Promiseã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getUsers</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
			<span class="nx">resolve</span><span class="p">({</span>
				<span class="na">users</span><span class="p">:</span> <span class="p">[{</span>
					<span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span>
				<span class="p">}]</span>
			<span class="p">})</span>
		<span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span></code></pre></figure>

<p>å½“getUserså‡½æ•°æˆåŠŸæ—¶å€™ä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼ŒPromiseçš„resolvesä¼šæºå¸¦ç€å¿…è¦çš„æ•°æ®ã€‚åŒæ—¶æˆ‘ä»¬èƒ½å¾ˆå¥½çš„å¤„ç†è¶…è¿‡ä¸€ä¸ªPromiseçš„æƒ…å†µï¼Œæˆ–è€…ä¸€ä¸ªPromiseä¾èµ–äºå¦å¤–ä¸€ä¸ªPromiseå’Œä¸€ä¸ªæ“ä½œéœ€è¦æ‰€æœ‰çš„Promiseä¸€èµ·è¿è¡Œæ‰èƒ½è§£å†³é—®é¢˜çš„æƒ…å†µï¼Œä»¥ä¸Šè¿™ä¸¤ç§æƒ…å†µï¼Œå…¶å®æ ‡å‡†çš„Promiseå®ç°å°±å¯ä»¥è¦†ç›–åˆ°ã€‚ç¬¬ä¸€ç§é“¾å¼æƒ…å†µå¯ä»¥ä½¿ç”¨Promiseçš„thenå®ç°ï¼Œåä¸€ç§å¯ä»¥ä½¿ç”¨Promise.allæ¥å®ç°ã€‚</p>

<p>Promiseå¯ä»¥è¢«çœ‹æˆæ˜¯å›è°ƒï¼ˆå›è°ƒåœ°ç‹±ï¼‰çš„ä¸€ç§æ›´åŠ ç®€æ´çš„æ›¿æ¢æ–¹æ¡ˆï¼Œå‡å¦‚ä½ ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯å›è°ƒåœ°ç‹±ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">asyncCallOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">asyncCallTwo</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">asyncCallThree</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">asyncCallFour</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">asyncCallFive</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                  <span class="c1">// do something here...</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span></code></pre></figure>

<p>å½“æˆ‘ä»¬å¤„ç†ä¸æ˜¯å¾ˆå¤æ‚ä»£ç çš„æ—¶å€™ç”¨åµŒå¥—å‡½æ•°çœ‹èµ·æ¥è¿˜ä¸é”™ï¼Œä½†æ˜¯åµŒå¥—ä»£ç ä¸åˆ©äºæ‰©å±•å’Œç»´æŠ¤ï¼Œè¿™é‡Œæœ‰ä¸€ç§æ›´å¥½çš„æ–¹å¼ä»ä¸€å¼€å§‹å°±å¯ä»¥é¿å…å›è°ƒåœ°ç‹±ï¼Œå°±æ˜¯ä½¿ç”¨Promiseï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°é¿å…å›è°ƒåµŒå¥—ï¼Œè¿˜å¯ä»¥æ›´å¥½çš„å¤„ç†å¼‚å¸¸ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">asyncCallOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// do some something... } )</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">asyncCallTwo</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">asyncCallThree</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">asyncCallFour</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">asyncCallFive</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// handle any errors that happened a long the way</span>
    <span class="p">})</span></code></pre></figure>

<p>åœ¨è¿è¡Œæ‰€æœ‰çš„å¼‚æ­¥å‡½æ•°åå†æ¥ä½¿ç”¨Thenä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
     <span class="nx">asyncCallOne</span><span class="p">,</span>
     <span class="nx">asyncCallTwo</span><span class="p">,</span>
     <span class="nx">asyncCallThree</span>
    <span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">values</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// do something with the values...</span>
    <span class="p">});</span></code></pre></figure>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å¤ä¹ äº†ä¸€ä¸‹Callbackå’ŒPromiseçš„åŸºæœ¬ç”¨æ³•ï¼Œæ¥ä¸‹æ¥å¯ä»¥ä»‹ç»ä¸‹ES6ä¸­çš„Generatorã€‚</p>

<h3 id="generator">Generator</h3>
<p>åœ¨æˆ‘ä»¬è®²what,why,howä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹Generatorç®€çŸ­å®šä¹‰ã€‚</p>

<blockquote>
  <p>â€œGenerators are functions that can be paused and resumed, which enables a variety of applications.â€</p>
</blockquote>

<p>(<a href="(http://www.2ality.com/2015/03/es6-generators.html)">http://www.2ality.com/2015/03/es6-generators.html</a>)</p>

<p>ä¸ºäº†å¿«é€Ÿçš„æ€»ç»“Generatorï¼Œå®ƒä»¬å¯ä»¥ä½¿æˆ‘ä»¬é€šè¿‡è°ƒç”¨åœ¨ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ä¸Šé¢è°ƒç”¨yieldå’Œé€šè¿‡nextè·å–åˆ°å€¼ç”Ÿæˆä¸€ä¸ªå€¼çš„åºåˆ—ã€‚</p>

<p>è¿™ä¸€å°æ®µå¾ˆåŸºç¡€çš„ä»£ç å¯ä»¥ç”¨æ¥ç¤ºèŒƒæ€ä¹ˆä½¿ç”¨Generatorã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span><span class="o">*</span> <span class="nx">getNumbers</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="mi">1</span>
  <span class="k">yield</span> <span class="mi">5</span>
  <span class="k">yield</span> <span class="mi">10</span>
<span class="p">}</span>
<span class="c1">// retrieving</span>
<span class="kd">const</span> <span class="nx">getThoseNumbers</span> <span class="o">=</span> <span class="nx">getNumbers</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value:1, done:false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value:5, done:false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value:10, done:false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value:undefined, done:true}</span></code></pre></figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Generatoræ¥åšè¿­ä»£ï¼Œä¹Ÿå¯ä»¥ç”¨å®ƒä»¬ç”¨æ¥observeæ•°æ®ï¼ŒåŒæ—¶ä¹Ÿå¾ˆé€‚åˆlazy evaluationå’Œcontrol flowã€‚</p>

<p>è¿™å„¿æœ‰ä¸€ç»„å…³äºå¦‚ä½•ä»Generatorè·å–å€¼çš„ä¾‹å­ï¼Œæœ€åä¸€ä¸ªè¿˜å±•ç¤ºäº†å¦‚ä½•é€šè¿‡reduceè·å–æ•°æ®ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// iterate</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">getNumbers</span><span class="p">())</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="c1">// 1 5 10</span>
<span class="p">}</span>
<span class="c1">// destructering</span>
<span class="kd">let</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getNumbers</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="c1">// 1 5 10</span>
<span class="c1">// spread operator</span>
<span class="kd">let</span> <span class="nx">spreaded</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">getNumbers</span><span class="p">()]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">spreaded</span><span class="p">)</span> <span class="c1">// [1, 5, 10]</span>
<span class="c1">// even works with reduce</span>
<span class="c1">// Ramda reduce for example</span>
<span class="kd">const</span> <span class="nx">reducing</span> <span class="o">=</span> <span class="nx">reduce</span><span class="p">((</span><span class="nx">xs</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[...</span><span class="nx">xs</span><span class="p">,</span> <span class="nx">x</span><span class="p">],</span> <span class="p">[],</span> <span class="nx">getNumbers</span><span class="p">())</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">reducing</span><span class="p">)</span> <span class="c1">// [1, 5, 10]</span></code></pre></figure>

<p>æ­¤å¤–Generatorå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡nextä¼ é€’æ•°æ®ï¼Œæ¯”è¾ƒå¥‡è‘©çš„æ˜¯ç¬¬ä¸€ä¸ªnextåªä¼šå¼€å¯è¿™ä¸ªè¿­ä»£ï¼Œç¬¬äºŒä¸ªnextæ‰å¯ä»¥å–åˆ°æ­£å¸¸çš„å€¼ï¼Œæ­¤ä¾‹å­å¯ä»¥å¾ˆå¥½è¯´æ˜åœ°ä¸Šé¢é—®é¢˜ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span><span class="o">*</span> <span class="nx">setGetNumbers</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="k">yield</span>
    <span class="k">yield</span> <span class="nx">input</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">setThoseNumbers</span> <span class="o">=</span> <span class="nx">setGetNumbers</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">setThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1">//{value:undefined, done:false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">setThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="c1">//{value: 2, done: false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">setThoseNumbers</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">//{value: undefined, done: true}</span></code></pre></figure>

<p>ä»ä¸Šé¢çš„è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªnextæ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Œä»…ä»…ä»ç¬¬äºŒä¸ªnextå¼€å§‹è€ƒè™‘å°±å¥½ã€‚</p>

<p>ç»ˆæ­¢ä¸€ä¸ªGeneratoræ˜¯å¾ˆç®€å•çš„ï¼Œåªéœ€è¦åœ¨Generatoré‡Œé¢å®šä¹‰ä¸€ä¸ªreturnå°±å¥½ã€‚åŒæ—¶ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ï¼ŒGeneratorå‡½æ•°å¯ä»¥è°ƒç”¨å…¶ä»–çš„Generatorå‡½æ•°ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span><span class="o">*</span> <span class="nx">callee</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="kd">function</span><span class="o">*</span> <span class="nx">caller</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">yield</span><span class="o">*</span> <span class="nx">callee</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">callerCallee</span> <span class="o">=</span> <span class="nx">caller</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">callerCallee</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value: 1, done: false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">callerCallee</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value: 1, done: false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">callerCallee</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value: 1, done: false}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">callerCallee</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="c1">// {value: 1, done: false}</span></code></pre></figure>

<p>ç°åœ¨å¤§å®¶åº”è¯¥å¯¹Generatoræœ‰ä¸€ä¸ªåŸºç¡€çš„ç†è§£äº†ã€‚
å…³äºES6ä¸­Generatoræ›´è¯¦ç»†çš„çš„ä»‹ç»ï¼Œå¯ä»¥é˜…è¯» <a href="https://medium.com/u/7fab51e62203">Axel Rauschmayer</a>è¿™ç¯‡æ›´å…¨é¢çš„æ–‡ç« <a href="http://www.2ality.com/2015/03/es6-generators.html">ES6 Generators in depth</a>ã€‚</p>

<h3 id="generator-promise-and-coroutine">Generator, Promise and Coroutine</h3>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»åŸºæœ¬äº†è§£Promiseå’ŒGeneratoräº†ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å°†è¿™ä¸¤è€…ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">fetchUsers</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">({</span>
        <span class="na">users</span><span class="p">:</span> <span class="p">[{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">}]</span>
      <span class="p">})</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
<span class="kd">function</span><span class="o">*</span> <span class="nx">getData</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fetchUsers</span><span class="p">()</span>
  <span class="k">yield</span> <span class="nx">data</span>
<span class="p">}</span></code></pre></figure>

<p>æ˜¾è€Œæ˜“è§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æœºåˆ¶æ¥ç¡®ä¿ä¸ç”¨æ‰‹åŠ¨æ¥è¿è¡Œå¾ªç¯ã€‚è¿™å°±æ˜¯Coroutineå‘æŒ¥ä½œç”¨çš„åœ°æ–¹äº†ï¼Œå®ƒä»¬å¯ä»¥ä½¿æˆ‘ä»¬å†™èƒ½å¤Ÿå¤„ç†å¼‚æ­¥çš„è¡Œä¸ºï¼ŒåŒ…æ‹¬Promise,Thunkæˆ–è€…å…¶å®ƒçš„operateï¼Œ<a href="https://github.com/tj/co">co</a>å°±æ˜¯å¤„ç†è¿™ç§æƒ…å†µçš„ä¸€ä¸ªå…¸å‹çš„åº“ã€‚</p>

<p>æ¥ä¸‹æ¥çš„ä»£ç æ˜¯å¯¹coçš„ä¸€ç§å¾ˆç®€å•ç²—ç³™çš„å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œçœ‹åˆ°coå‡½æ•°æ˜¯æ€ä¹ˆè¿è¡Œçš„ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">co</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">()</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">run</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">done</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
      <span class="c1">// check if done and return if finished</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
      <span class="c1">// retrieve the promise and call next with the result</span>
      <span class="nx">value</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">run</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">obj</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1">// start</span>
    <span class="nx">run</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span></code></pre></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€åŒ–coå‡½æ•°æ¥å®ç°ä¹‹å‰fetchæ•°æ®çš„é‚£ä¸ªä¾‹å­ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">fetchUsers</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">({</span>
        <span class="na">users</span><span class="p">:</span> <span class="p">[{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">}]</span>
      <span class="p">})</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">fetchOtherData</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">({</span>
        <span class="na">other</span><span class="p">:</span> <span class="p">[{</span><span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">other data</span><span class="dl">'</span><span class="p">}]</span>
      <span class="p">})</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="kd">get</span> <span class="o">=</span> <span class="nx">co</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">getData</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="k">yield</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">fetchOtherData</span><span class="p">(),</span> <span class="nx">fetchUsers</span><span class="p">()])</span>
  <span class="c1">// do something else...</span>
  <span class="k">return</span> <span class="nx">getAll</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span></code></pre></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Coroutineèƒ½è®©æˆ‘ä»¬å†™é‚£ç§çœ‹èµ·æ¥æ˜¯åŒæ­¥çš„ä»£ç æ¥å®ç°å¼‚æ­¥ï¼Œå¦‚ä¸‹</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="kd">get</span> <span class="o">=</span> <span class="nx">co</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="nx">getData</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">otherData</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fetchOtherData</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetched other data: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">otherData</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fetchUsers</span><span class="p">(</span><span class="nx">otherData</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetched users: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">users</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span></code></pre></figure>

<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡Coroutineè¿™ç§æ–¹å¼å¯ä»¥ç”¨æ¥åˆå¹¶Generatorå’ŒPromiseã€‚è¿™æ ·çœ‹èµ·æ¥ä¸é”™ï¼Œå…¶å®è¿˜æœ‰ä¸€ç§æ›´å¥½çš„å®ç°æ–¹æ¡ˆï¼Œå°±æ˜¯ä½¿ç”¨Channelæ¥åˆå¹¶Generatorã€‚</p>

<h3 id="generator-and-channel">Generator and Channel</h3>

<blockquote>
  <p>Donâ€™t combine Generators with Promises, combine them with Channels!   â€“ David Nolen</p>
</blockquote>

<p><a href="http://swannodette.github.io/2013/08/24/es6-generators-and-csp">(http://swannodette.github.io/2013/08/24/es6-generators-and-csp)</a></p>

<p>åœ¨ä¹‹å‰æ‰€ä»¥å¤„ç†å¼‚æ­¥çš„æ–¹æ³•å¤§å®¶åŸºæœ¬éƒ½çŸ¥é“ï¼ˆæ¯”å¦‚ç¥å¥‡çš„setTimeoutï¼‰ï¼Œæœ‰è¶£çš„æ˜¯channelåƒæ˜¯äº‹åæ‰ç»™jsåŠ ä¸Šå»çš„ã€‚Clojure é€šè¿‡ core.async ä»¥åŠ Go é€šè¿‡ goroutines å·²ç»å¯¹ channels æä¾›æ”¯æŒæœ‰ä¸€æ®µæ—¶é—´äº†ã€‚</p>

<p>è¿™é‡Œæœ‰å¾ˆå¤šå…³äºè¿™æ–¹é¢çš„æ–‡ç« ï¼Œå…¶ä¸­æœ€æ˜¾è‘—çš„ä¸€ç¯‡æ˜¯James Longsterçš„<a href="http://jlongster.com/Taming-the-Asynchronous-Beast-with-CSP-in-JavaScript">Taming the Asynchronous Beast with CSP Channels in JavaScript</a>è¿™ç¯‡æ–‡ç« ã€‚é€šè¿‡è¿™ç¯‡æ–‡ç« å¯ä»¥å¯¹Channelæœ‰ä¸€ä¸ªæ›´æ·±çš„ç†è§£ã€‚</p>

<p>è¿™æ˜¯æˆ‘ç›´æ¥ä»James Longsteré‚£ç¯‡æ–‡ç« ä¸­æ‘˜æŠ„çš„ä¸€å¥è¯ï¼š</p>

<blockquote>
  <p>Typically channels are useful for coordinating truly concurrent tasks that might run at the same time on separate threads. They are actually just as useful in a single-threaded environment because they solve a more general problem of coordinating anything asynchronous, which is everything in JavaScript.â€“James Longster</p>
</blockquote>

<p><a href="http://jlongster.com/Taming-the-Asynchronous-Beast-with-CSP-in-JavaScript">Taming the Asynchronous Beast with CSP in JavaScript</a></p>

<p>å½“ä½ é˜…è¯»Channelè¿™ä¸ªè¯çš„æ—¶å€™ï¼Œä½ ä¹Ÿä¼šç»å¸¸ä¼šçœ‹åˆ°CSP ï¼Œå®ƒçš„æ„æ€æ˜¯æŒ‡Communicating Sequential Processesï¼Œæˆ‘æ¨èè¯»David Nolençš„<a href="http://swannodette.github.io/2013/07/12/communicating-sequential-processes">Communicating Sequential Processes</a>è¿™ç¯‡æ–‡ç« å¯¹CSPæœ‰ä¸€ä¸ªæ›´å¥½çš„ç†è§£ã€‚</p>

<p>æˆ‘ä»¬å°†ä¼šä½¿ç”¨<a href="https://github.com/ubolonton/js-csp">js-csp</a>è¿™ä¸ªåº“æ¥æ¼”ç¤ºä½¿ç”¨Channelå¯¹æˆ‘ä»¬åˆ°åº•æœ‰ä»€ä¹ˆå¥½å¤„ã€‚</p>

<p>é€šè¿‡Channelæ¥è¿›è¡Œè¿›ç¨‹é€šä¿¡ï¼Œå…¸å‹çš„Channelå¸¸å¸¸ä¼šæä¾›ä¸€ç»„å‡½æ•°ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªéœ€çŸ¥é“putå’Œtakeçš„ç”¨æ³•å°±å¥½ï¼Œå…¥æ ˆä½¿ç”¨pushï¼Œé€šè¿‡takeæœ‰ä¸€ä¸ªè¿‡ç¨‹åœ¨å¦ä¸€è¾¹ç­‰å¾…ã€‚å¾ˆå¿«æˆ‘ä»¬å°†ä¼šçœ‹åˆ°æ›´æ¸…æ™°çš„ç»†èŠ‚ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªchannelå’Œconsumerï¼Œå¦‚ä¸‹æ˜¯js-cspæ–‡æ¡£ä¸­çš„ç®€åŒ–ç‰ˆä¾‹å­ï¼š</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">csp</span><span class="p">.</span><span class="nx">chan</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="k">yield</span> <span class="nx">csp</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
<span class="k">yield</span> <span class="nx">csp</span><span class="p">.</span><span class="nx">take</span><span class="p">(</span><span class="nx">ch</span><span class="p">);</span> <span class="c1">// 42</span>
<span class="nx">ch</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="k">yield</span> <span class="nx">csp</span><span class="p">.</span><span class="nx">take</span><span class="p">(</span><span class="nx">ch</span><span class="p">);</span> <span class="c1">// csp.CLOSED</span></code></pre></figure>

<p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºå¤§å°ä¸º1çš„Channelï¼Œæ¥ç€æˆ‘ä»¬é€šè¿‡å‰ç¼€yieldè°ƒç”¨putï¼Œå°†42è¿™ä¸ªå€¼ä¼ é€’åˆ°Channelã€‚æ¥ç€æˆ‘ä»¬ä»Channelä¸­takeè¿™ä¸ªå€¼å¹¶æœ€åå…³é—­Channelï¼Œåœ¨Channelå·²ç»å…³é—­åï¼Œæ¥ä¸‹æ¥yieldä¸ä¼šäº§ç”Ÿå½±å“ã€‚</p>

<p>ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯ç›´æ¥ä»js-cspæ–‡æ¡£ä¸­æ‹¿è¿‡æ¥çš„ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">go</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="nx">timeout</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">},</span> <span class="p">[</span><span class="mi">42</span><span class="p">]);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">((</span><span class="k">yield</span> <span class="nx">take</span><span class="p">(</span><span class="nx">ch</span><span class="p">)));</span></code></pre></figure>

<p>é€šè¿‡è°ƒç”¨goæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªGoroutineï¼Œå®ƒä¼šç«‹å³è¿”å›ä¸€ä¸ªChannelï¼Œä½¿æˆ‘ä»¬é€šè¿‡takeä»Channelè·å–ä»»ä½•å€¼ã€‚</p>

<p>ä¸ºäº†äº†è§£è¿™ä¸€åˆ‡å¦‚ä½•å’ŒUIç›¸æ­é…ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªlistenå‡½æ•°ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">listen</span> <span class="o">=</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">chan</span><span class="p">()</span>
  <span class="nx">el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">putAsync</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">e</span><span class="p">))</span>
  <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span></code></pre></figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨listenå°†ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆchannelã€‚å¯ä»¥é€šè¿‡åœ¨channelä¸Šé¢ä½¿ç”¨takeæ¥ç›‘å¬æ‰€æœ‰çš„æ”¹åŠ¨ã€‚æ— è®ºæˆ‘ä»¬åœ¨inputæ¡†é‡Œé¢è¾“å…¥ä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡channelè·å–åˆ°æ”¹åŠ¨å¹¶æ›´æ–°åˆ°æ˜¾ç¤ºå…ƒç´ ä¸Šã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">go</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">display</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">listen</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">take</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`From Input: </span><span class="p">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">}</span><span class="s2">`</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

<h3 id="using-generators-and-channels-with-react">Using Generators and Channels with React</h3>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»å°†åŸºç¡€éƒ¨åˆ†ä»‹ç»å®Œæ¯•ï¼ŒåŒæ—¶å¯¹ä¸ºä»€ä¹ˆChannelå’ŒGeneratoråœ¨Javascriptä¸­æœ‰æ„ä¹‰æœ‰ä¸€ä¸ªæ›´æ·±çš„ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å°†å­¦åˆ°Channelå’ŒGeneratorç”¨åˆ°å®é™…ä»£ç æƒ…æ™¯ä¸­ã€‚</p>

<p>ä¸€ä¸ªç»å…¸çš„ä¾‹å­å°±æ˜¯è®¡æ•°å™¨ç»„ä»¶ï¼Œè™½ç„¶å¾ˆåŸºç¡€ï¼Œåªèƒ½å¤Ÿå¢åŠ å’Œå‡å°‘æ•°å­—å¹¶å°†å½“å‰æ•°å­—æ˜¾ç¤ºå‡ºæ¥ï¼Œä½†æ˜¯é€šè¿‡è¿™ä¸ªå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯¹Reactæ¸²æŸ“Componentè·å¾—æ›´æ¸…æ™°çš„è®¤è¯†ã€‚</p>

<p>ä½ å¯ä»¥ä» <a href="https://medium.com/u/749b96458fd8">Stefan Oestreicher</a>çš„<a href="https://github.com/steos/elmar.js/blob/master/src/examples/SimpleCounter.js">React/Elm-Architecturezh</a>ä¸­è·å¾—å®Œæ•´ä»£ç ã€‚</p>

<p>AppStartç”¨æ¥å¤„ç†é¡¶å±‚React Componentçš„åˆå§‹åŒ–æ¸²æŸ“ï¼Œå’Œå¼€å¯ä¸€ä¸ªç”¨æ¥ç­‰å¾…ä»»ä½•åœ¨AppChannelä¸Šçš„æ›´æ–°çš„Goroutineã€‚</p>

<p>AppChannelæ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•ç¼“å†²æˆ–å…¶ä»–ç‰¹æ®Šæ€§çš„å‡½æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åšçš„æ˜¯ä¸€æ—¦æœ‰ä¸€ä¸ªeventå¼•å‘äº†ä¸€ä¸ªactionå˜åŒ–ï¼Œæˆ‘ä»¬åœ¨AppChannelä½¿ç”¨putæ–¹æ³•éƒ½è·å–åˆ°ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// basic example demonstrating the power of channels and generators</span>
<span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">render</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-dom</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">chan</span><span class="p">,</span> <span class="nx">go</span><span class="p">,</span> <span class="nx">take</span><span class="p">,</span> <span class="nx">put</span><span class="p">,</span> <span class="nx">putAsync</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">js-csp</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">curry</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ramda</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Counter</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./Counter</span><span class="dl">'</span>
<span class="c1">// helper</span>
<span class="kd">const</span> <span class="nx">createRender</span> <span class="o">=</span> <span class="nx">curry</span><span class="p">((</span><span class="nx">node</span><span class="p">,</span> <span class="nx">app</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">render</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">node</span><span class="p">))</span>
<span class="c1">// create one channel for now</span>
<span class="kd">const</span> <span class="nx">AppChannel</span> <span class="o">=</span> <span class="nx">chan</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">doRender</span> <span class="o">=</span> <span class="nx">createRender</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">mountNode</span><span class="dl">'</span><span class="p">))</span>
<span class="c1">// let start</span>
<span class="kd">const</span> <span class="nx">AppStart</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">init</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">view</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">model</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">const</span> <span class="nx">signal</span> <span class="o">=</span> <span class="nx">action</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="nx">update</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
        <span class="nx">putAsync</span><span class="p">(</span><span class="nx">AppChannel</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// initial render...</span>
    <span class="nx">putAsync</span><span class="p">(</span><span class="nx">AppChannel</span><span class="p">,</span> <span class="nx">init</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span>
    <span class="nx">go</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">doRender</span><span class="p">(</span><span class="nx">view</span><span class="p">(</span><span class="nx">signal</span><span class="p">,</span> <span class="k">yield</span> <span class="nx">take</span><span class="p">(</span><span class="nx">AppChannel</span><span class="p">)))</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
<span class="c1">// start</span>
<span class="nx">AppStart</span><span class="p">(</span><span class="nx">Counter</span><span class="p">)</span></code></pre></figure>

<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºç¡€çš„ä¾‹å­å·²ç»å¯åŠ¨åœ¨è¿è¡Œä¸­ï¼Œè¿˜å¯ä»¥åœ¨ä¸Šé¢åšä¸€äº›å¤æ‚çš„äº‹æƒ…ï¼Œä¾‹å¦‚fetchæ“ä½œã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç®€å•åˆ—è¡¨ï¼Œå¯ä»¥ä»å…¶ä»–èµ„æºåœ°æ–¹fetchè·å–æ•°æ®ï¼Œä¸€æ—¦stateå‘ç”Ÿå˜åŒ–åï¼Œé‡æ–°æ¸²æŸ“ç»“æœã€‚ä¸ºäº†å®Œæˆæ­¤ä»»åŠ¡ï¼ŒåŒæ—¶ä¸ºäº†æ›´å¥½çš„ä½“éªŒå°†ä¼ é€’ä¸€ä¸ªloadingä¿¡æ¯ç»™ç”¨æˆ·ã€‚</p>

<p>ä¸Šé¢è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å•ç‹¬çš„å¤„ç†Actionå’ŒChannelï¼ŒåŒæ—¶ä¹Ÿéœ€è¦åœ¨ä¸€ä¸ªå¹²å‡€çš„ã€è‰¯å¥½ç»„ç»‡ä¸‹çš„ä»£ç ä¸‹å¤„ç†å…¶ä¸€äº›é¢å¤–çš„æƒ…å†µã€‚</p>

<h4 id="building-the-app">Building the Appâ€¦</h4>
<p>å®é™…ä¸Šæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥å¤„ç†fetchæ“ä½œå’Œé€šçŸ¥loadingä»€ä¹ˆæ—¶å€™å¼€å¯å’Œç»“æŸã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">getItems</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">go</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">put</span><span class="p">(</span><span class="nx">isLoading</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">fetchedItems</span> <span class="o">=</span> <span class="k">yield</span><span class="o">*</span> <span class="nx">fetchItems</span><span class="p">()</span>
    <span class="k">yield</span> <span class="nx">put</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="nx">fetchedItems</span><span class="p">)</span>
    <span class="k">yield</span> <span class="nx">put</span><span class="p">(</span><span class="nx">isLoading</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span></code></pre></figure>

<p>ç¼–å†™ä¸€ä¸ªåˆ›å»ºChannelçš„å‡½æ•°ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">createChannel</span> <span class="o">=</span> <span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">chan</span><span class="p">()</span>
  <span class="nx">go</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">take</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
      <span class="k">yield</span> <span class="nx">put</span><span class="p">(</span><span class="nx">AppChannel</span><span class="p">,</span> <span class="nx">action</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="kd">get</span><span class="p">(),</span> <span class="nx">value</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>

<span class="c1">// helper function for passing an object and getting channels</span>
<span class="kd">const</span> <span class="nx">createChannels</span> <span class="o">=</span> <span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="nx">mapObjIndexed</span><span class="p">(</span><span class="nx">fn</span> <span class="o">=&gt;</span> <span class="nx">createChannel</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">store</span><span class="p">),</span> <span class="nx">actions</span><span class="p">)</span></code></pre></figure>

<p>ç°åœ¨å·²ç»æœ‰createChanneläº†ï¼Œæˆ‘ä»¬è¿˜éœ€å®šä¹‰ä¸€ç»„Actionã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">Actions</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">isLoading</span><span class="p">:</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">isLoading</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">assoc</span><span class="p">(</span><span class="dl">'</span><span class="s1">isLoading</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isLoading</span><span class="p">,</span> <span class="nx">model</span><span class="p">),</span>
  <span class="na">items</span><span class="p">:</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">items</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">assoc</span><span class="p">(</span><span class="dl">'</span><span class="s1">items</span><span class="dl">'</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">model</span><span class="p">),</span>
  <span class="na">addItem</span><span class="p">:</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">assoc</span><span class="p">(</span><span class="dl">'</span><span class="s1">items</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">[</span> <span class="p">...</span><span class="nx">prop</span><span class="p">(</span><span class="dl">'</span><span class="s1">items</span><span class="dl">'</span><span class="p">,</span> <span class="nx">model</span><span class="p">),</span>
        <span class="p">{</span><span class="nx">title</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">getNextId</span><span class="p">(</span><span class="nx">prop</span><span class="p">(</span><span class="dl">'</span><span class="s1">items</span><span class="dl">'</span><span class="p">,</span> <span class="nx">model</span><span class="p">))}</span>
      <span class="p">],</span>
      <span class="nx">model</span><span class="p">),</span>
<span class="p">}</span></code></pre></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†™Appçš„Componentéƒ¨åˆ†ï¼Œè¿™é‡Œæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œä»…ä»…å°±æ˜¯ä¸€ä¸ªlistå’Œä¸¤ä¸ªbuttonå’Œä¸€ä¸ªinputï¼Œç¬¬ä¸€ä¸ªbuttonç”¨äºè·å–åˆ—è¡¨æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ªç”¨äºæ·»åŠ æ–‡æœ¬åˆ°inputé‡Œã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">isLoading</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">loading</span><span class="p">...</span><span class="o">&lt;</span><span class="sr">/p&gt;</span><span class="err">)
</span>  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Random</span> <span class="nx">Items</span> <span class="nx">List</span><span class="o">&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="p">(</span>
          <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span> <span class="o">&gt;</span><span class="p">{</span><span class="nx">item</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>        <span class="p">))}</span>
      <span class="o">&lt;</span><span class="sr">/ul</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">'</span><span class="s1">text</span><span class="dl">'</span> <span class="nx">id</span><span class="o">=</span><span class="dl">'</span><span class="s1">add</span><span class="dl">'</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">putAsync</span><span class="p">(</span><span class="nx">addItem</span><span class="p">,</span> <span class="nx">findText</span><span class="p">())}</span><span class="o">&gt;</span>
        <span class="nx">Add</span> <span class="nx">Item</span>
      <span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">getItems</span><span class="p">()}</span><span class="o">&gt;</span><span class="nx">LoadItems</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>ç°åœ¨å·²ç»åŸºæœ¬ä¸Šå†™å¥½äº†ï¼Œç±»ä¼¼äºæˆ‘ä»¬ä¹‹å‰è¿™æ ·ï¼Œåˆ›å»ºä¸€ä¸ªAppStartå‡½æ•°ï¼ŒåŒæ—¶å®ƒè¿˜å¸Œæœ›æœ‰ä¸€ä¸ªcomponentå’Œä¸€ä¸ªç±»å‹storeã€‚storeå°±æ˜¯ä¸€ä¸ªç”¨äºå­˜æ”¾getterå’Œsetterçš„ç®€å•å¯¹è±¡ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">AppStart</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Component</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// initial render...</span>
  <span class="nx">putAsync</span><span class="p">(</span><span class="nx">AppChannel</span><span class="p">,</span> <span class="nx">store</span><span class="p">.</span><span class="kd">get</span><span class="p">())</span>
  <span class="nx">go</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="k">yield</span> <span class="nx">take</span><span class="p">(</span><span class="nx">AppChannel</span><span class="p">))</span>
      <span class="nx">doRender</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">Component</span> <span class="p">{...</span><span class="nx">store</span><span class="p">.</span><span class="kd">get</span><span class="p">()</span> <span class="p">}</span> <span class="sr">/&gt;</span><span class="err">)
</span>    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span></code></pre></figure>

<p>ç°åœ¨æˆ‘ä»¬éœ€è¦åšçš„æ˜¯ä¸ºå…ˆå‰å®šä¹‰çš„Actionsåˆ›å»ºæˆ‘ä»¬çš„Channelsã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="p">{</span> <span class="nx">isLoading</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">addItem</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">createChannels</span><span class="p">(</span><span class="nx">Actions</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span></code></pre></figure>

<p>æˆ‘ä»¬åœ¨returnä¸­è·å¾—ä¸€ä¸ªisLoadingï¼Œä¸€ä¸ªitemså’Œä¸€ä¸ªaddItemçš„channelï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡channelæ¥æ›´æ–°æˆ‘ä»¬çš„çŠ¶æ€ï¼Œè¿˜æœ‰éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAppChannelè¢«ç§°ä¸ºä¸€ä¸ªåªå¤„ç†æœ€æ–°å€¼çš„æ»‘åŠ¨ç¼“å†²ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// create App channel... and render function</span>
<span class="kd">const</span> <span class="nx">AppChannel</span> <span class="o">=</span> <span class="nx">chan</span><span class="p">(</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">sliding</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="kd">const</span> <span class="nx">doRender</span> <span class="o">=</span> <span class="nx">createRender</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">mountNode</span><span class="dl">'</span><span class="p">))</span></code></pre></figure>

<p>æœ€åæˆ‘ä»¬åªéœ€è¦è°ƒç”¨AppStartå°±å¥½äº†ã€‚</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">AppStart</span><span class="p">(</span><span class="nx">App</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span></code></pre></figure>

<p>ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¿«é€Ÿçš„æ¡ˆä¾‹æ¥è§£é‡ŠReactæ€ä¹ˆç»“åˆChannelä¸€èµ·ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ—¶é—´æ¥æ€è€ƒå’ŒéªŒè¯è¿™ç§æ–¹æ¡ˆæ€ä¹ˆå¼„æ‰å¯¹äºæˆ‘ä»¬æœ‰ä»€ä¹ˆå¥½å¤„ã€‚</p>

<p>é€šè¿‡ä¹‹å‰é‚£èŠ‚ä¸­çš„listenå‡½æ•°ï¼Œæˆ‘ä»¬æ€ä¹ˆå°†ä¸€ä¸ªå…ƒç´ è½¬æ¢æˆä¸€ä¸ªChannelï¼Œä»è€ŒæŠ›ç –å¼•ç‰ï¼Œå¼•å‡ºå…¶ä»–çš„æƒ³æ³•ï¼ŒåŒ…æ‹¬å¯¹windowçš„ååº”ï¼Œæ”¹å˜ä½ çš„Appçš„ç»“æ„ï¼Œæ ·å¼æˆ–å¸ƒå±€ã€‚</p>

<p>ä»¥ä¸Šæä¾›çš„ä¾‹å­å¯ä»¥çœ‹æˆä¸€ä¸ªä½¿ç”¨è¯¥æ–°ç‰¹æ€§å¯èƒ½æ€§çš„æ–°èµ·ç‚¹ã€‚</p>

<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™æ˜¯ä¸€ç¯‡ä»‹ç»Generatorå’ŒChannelçš„æ–‡ç« ï¼Œæˆ‘ä»¬ä»»ç„¶ç¼ºå°‘ä¸€äº›é‡è¦çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚Transducerï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« å°†ä¼šè¦†ç›–Channelså’ŒTransducerï¼ŒåŒ…æ‹¬æ›´å¤šä½¿ç”¨Reactçš„ä¾‹å­ã€‚</p>

<h4 id="æ›´æ–°">æ›´æ–°</h4>
<p>ç›®å‰å·²ç»å‘å¸ƒ<a href="https://medium.com/javascript-inside/introduction-into-channels-and-transducers-in-javascript-a1dfd0a09268#.nfmcntwy7">Introduction into Channels and Transducers in JavaScript</a> ã€‚</p>

<h3 id="links">Links</h3>

<p><a href="http://www.2ality.com/2015/03/es6-generators.html">ES6 Generators in depth</a></p>

<p><a href="http://swannodette.github.io/2013/08/24/es6-generators-and-csp">ES6 Generators Deliver Go Style Concurrency</a></p>

<p><a href="https://medium.com/@tjholowaychuk/callbacks-vs-coroutines-174f1fe66127#.ysrbpx5nb">Callbacks vs. Coroutines</a></p>

<p><a href="https://github.com/ubolonton/js-csp">js-csp</a></p>

<p><a href="http://jlongster.com/Taming-the-Asynchronous-Beast-with-CSP-in-JavaScript">Taming the Asynchronous Beast with CSP in JavaScript</a></p>

<p><a href="http://calculist.org/blog/2011/12/14/why-coroutines-wont-work-on-the-web/">Why coroutines wonâ€™t work on the web</a></p>

<p><a href="http://www.2ality.com/2015/03/no-promises.html">No promises: asynchronous JavaScript with only generators</a></p>

<p><a href="http://phuu.net/2014/08/31/csp-and-transducers.html">CSP and transducers in JavaScript</a></p>

<p><a href="https://github.com/clojure/core.async/">core.async</a></p>

<p><a href="http://swannodette.github.io/2013/07/12/communicating-sequential-processes">Communicating Sequential Processes</a></p>

<p><a href="http://swannodette.github.io/2013/07/31/extracting-processes">CSP is responsive design</a></p>

<p><a href="http://jlongster.com/A-Study-on-Solving-Callbacks-with-JavaScript-Generators">A Study on Solving Callbacks with JavaScript Generators</a></p>
:ET